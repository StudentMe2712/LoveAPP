"use server";

import { createClient } from "@/lib/supabase/server";
import { generateHomeInsight } from "@/lib/ai";

const quotes = [
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å —Å –∫–µ–º-—Ç–æ –≤—Å–µ —á–µ—Ç—ã—Ä–µ –≤—Ä–µ–º–µ–Ω–∏ –≥–æ–¥–∞.",
    "–°–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Å—á–∞—Å—Ç—å–µ –≤ –∂–∏–∑–Ω–∏ ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ —Ç–µ–±—è –ª—é–±—è—Ç.",
    "–°—á–∞—Å—Ç—å–µ ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –¥–æ–º–∞ —É—é—Ç–Ω–æ, —Ç–µ–ø–ª–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ. –ò —Ç–∞–∫ –∂–µ ‚Äî –≤ –¥—É—à–µ.",
    "–ò–¥–µ–∞–ª—å–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –≤—ã —Å—Å–æ—Ä–∏—Ç–µ—Å—å –∫–∞–∫ –ø–∞—Ä–∞, –±–æ–ª—Ç–∞–µ—Ç–µ –∫–∞–∫ –ª—É—á—à–∏–µ –¥—Ä—É–∑—å—è –∏ –∑–∞–±–æ—Ç–∏—Ç–µ—Å—å –¥—Ä—É–≥ –æ –¥—Ä—É–≥–µ.",
    "–°–æ–≤–µ—Ç –¥–Ω—è: –û–±–Ω–∏–º–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –±–µ–∑ –ø–æ–≤–æ–¥–∞. –ü—Ä–æ—Å—Ç–æ —Ç–∞–∫. –ö—Ä–µ–ø–∫–æ –∏ –¥–æ–ª–≥–æ.",
    "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –°–∫–∞–∑–∞—Ç—å ¬´–Ø —Ç–µ–±—è –ª—é–±–ª—é¬ª –º–æ–∂–Ω–æ –∏ –±–µ–∑ —Å–ª–æ–≤. –°–≤–∞—Ä–∏—Ç–µ –∫–æ—Ñ–µ, —É–∫—Ä–æ–π—Ç–µ –ø–ª–µ–¥–æ–º.",
    "–°–µ–∫—Ä–µ—Ç –¥–æ–ª–≥–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–µ–∫—Ä–∞—â–∞–π—Ç–µ —Ö–æ–¥–∏—Ç—å –Ω–∞ —Å–≤–∏–¥–∞–Ω–∏—è –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º.",
    "–õ—é–±–∏—Ç—å ‚Äî –∑–Ω–∞—á–∏—Ç –≤–∏–¥–µ—Ç—å —á—É–¥–æ, –Ω–µ–≤–∏–¥–∏–º–æ–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö.",
    "–î–µ—Ä–∂–∏—Ç–µ—Å—å –∑–∞ —Ä—É–∫–∏ —á–∞—â–µ. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –∂–µ—Å—Ç, –Ω–æ –æ–Ω —Ç–≤–æ—Ä–∏—Ç —á—É–¥–µ—Å–∞.",
    "–°–æ–≤–µ—Ç –¥–Ω—è: –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä —É—Å—Ç–∞–ª, –∏–Ω–æ–≥–¥–∞ –ª—É—á—à–∞—è –ø–æ–º–æ—â—å ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—Å–ª—É—à–∞—Ç—å –∏ –æ–±–Ω—è—Ç—å.",
    "–ù–∞—Å—Ç–æ—è—â–∞—è –ª—é–±–æ–≤—å –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ–ª–≥–∏–µ –≥–æ–¥—ã –±–ª–∏–∑–æ—Å—Ç–∏ –∏ –¥–µ–ª–∞–µ—Ç –∏—Ö —Ç–æ–ª—å–∫–æ –ª—É—á—à–µ.",
    "–í –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –æ—Ç—Ä–∞–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª—É—á—à–µ–µ –≤ —Å–≤–æ–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–µ.",
    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –∏—â–∏—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–π –ø–æ–≤–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —É–ª—ã–±–∫–∏.",
    "–°–º–µ—Ö ‚Äî —Å–∞–º—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å –º–µ–∂–¥—É –¥–≤—É–º—è –ª—é–¥—å–º–∏.",
    "–õ—é–±–∏—Ç—å ‚Äî –∑–Ω–∞—á–∏—Ç –≤–º–µ—Å—Ç–µ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –æ–¥–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏.",
    "–°–æ–≤–µ—Ç –¥–Ω—è: –ü–æ—Ö–≤–∞–ª–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∑–∞ –º–µ–ª–æ—á—å, –∫–æ—Ç–æ—Ä—É—é –æ–Ω –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
    "–ò–Ω–æ–≥–¥–∞ –ª—É—á—à–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä ‚Äî —ç—Ç–æ —É—é—Ç–Ω–æ–µ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –º–æ–ª—á–∞–Ω–∏–µ.",
    "–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å ¬´–°–ø–∞—Å–∏–±–æ¬ª –¥–∞–∂–µ –∑–∞ –ø—Ä–∏–≤—ã—á–Ω—ã–µ –¥–æ–º–∞—à–Ω–∏–µ –¥–µ–ª–∞.",
    "–û—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –≤—ã —É—á–∏—Ç–µ—Å—å –≤–∏–¥–µ—Ç—å –Ω–µ–∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∏–¥–µ–∞–ª—å–Ω—ã–º.",
    "–°–æ–≤–µ—Ç –¥–Ω—è: –û—Ç–ª–æ–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –≤–æ –≤—Ä–µ–º—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ —É–∂–∏–Ω–∞.",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ, —Å –∫–µ–º —Ç—ã –º–æ–∂–µ—à—å –∂–∏—Ç—å, –∞ —Ç–æ, –±–µ–∑ –∫–æ–≥–æ —Ç—ã –∂–∏—Ç—å –Ω–µ –º–æ–∂–µ—à—å.",
    "–õ—É—á—à–µ–µ, –∑–∞ —á—Ç–æ –º–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å—Å—è –≤ –∂–∏–∑–Ω–∏, - —ç—Ç–æ –¥—Ä—É–≥ –∑–∞ –¥—Ä—É–≥–∞.",
    "–£–≤–∞–∂–µ–Ω–∏–µ ‚Äî —ç—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç—Ä–æ–∏—Ç—Å—è –ª—é–±–æ–µ —Å–∏–ª—å–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ.",
    "–ú–∞–ª–µ–Ω—å–∫–∏–µ —Å—é—Ä–ø—Ä–∏–∑—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –±–æ–ª—å—à—É—é –ª—é–±–æ–≤—å.",
    "–í–º–µ—Å—Ç–µ –¥–∞–∂–µ —Å–∞–º—ã–µ –æ–±—ã—á–Ω—ã–µ –¥–µ–ª–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –æ—Å–æ–±–µ–Ω–Ω—ã–º–∏."
];

export async function fetchAIInsightAction() {
    try {
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
        return { data: { text: randomQuote } };
    } catch (err) {
        console.error("fetchAIInsightAction exception", err);
        return { error: "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Å–∞–π—Ç–∞" };
    }
}

export async function confirmAIProposalAction(type: string, payload: string) {
    try {
        const supabase = await createClient();
        const { data: { user } } = await supabase.auth.getUser();

        let userId = user?.id;
        if (!userId) { userId = "00000000-0000-0000-0000-000000000000"; }

        const { data: pairData, error: pairError } = await supabase
            .from("pair")
            .select("user1_id, user2_id")
            .limit(1)
            .single();

        let partnerTelegramId = process.env.TELEGRAM_GROUP_CHAT_ID;

        if (!partnerTelegramId && pairData) {
            // We might map partnerId to a telegram ID in the future
            // const partnerId = pairData.user1_id === userId ? pairData.user2_id : pairData.user1_id;
        }

        if (partnerTelegramId) {
            const { sendTelegramMessage } = await import("@/lib/notifications/telegram");

            if (type === 'message') {
                await sendTelegramMessage(partnerTelegramId, `‚ú® –°—é—Ä–ø—Ä–∏–∑ –æ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–∞:\n\n<i>${payload}</i>`);
            } else if (type === 'plan') {
                await sendTelegramMessage(partnerTelegramId, `üìÖ –í–∞—à –ø–∞—Ä—Ç–Ω–µ—Ä –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–æ–≤—ã–π –ø–ª–∞–Ω!\n\n<b>–ò–¥–µ—è:</b> <i>${payload}</i>`, [
                    [
                        { text: "–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è", callback_data: `reply_plan_accept` },
                        { text: "–ü–æ–∑–∂–µ", callback_data: `reply_plan_later` },
                    ]
                ]);
            }
        }

        return { success: true };
    } catch (err) {
        console.error("confirmAIProposalAction exception", err);
        return { error: "–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è" };
    }
}
